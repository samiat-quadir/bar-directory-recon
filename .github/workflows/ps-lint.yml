name: ps-lint
on:
  pull_request:
    branches: [ main ]
jobs:
  ps-lint:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    continue-on-error: true
    steps:
      - uses: actions/checkout@v5
      - name: Syntax check apply-attic-review.ps1 (DryRun)
        shell: pwsh
        run: pwsh -NoProfile -File scripts/apply-attic-review.ps1 -DryRun -PrNumber 0
      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force
      - name: Static analysis (warnings as non-blocking)
        shell: pwsh
        run: |
          Invoke-ScriptAnalyzer -Path scripts -Recurse -Severity Warning,Error
      - name: ps-lint readiness (7d)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const since = new Date(Date.now() - 7*24*60*60*1000).toISOString();
            const params = { owner, repo, per_page: 100, status: 'completed', created: `>${since}` };
            const runs = await github.paginate(github.rest.actions.listWorkflowRunsForRepo, params);
            const psRuns = (runs || []).filter(r => r.name && r.name.toLowerCase().includes('ps-lint'));
            const total = psRuns.length;
            const success = psRuns.filter(r => r.conclusion === 'success').length;
            core.summary.addHeading('ps-lint readiness (7d)');
            core.summary.addRaw(`- Total ps-lint runs: ${total}`);
            core.summary.addRaw(`- Successful: ${success}`);
            core.summary.addRaw(`- Success rate: ${total ? ((success/total*100).toFixed(1)+'%') : 'n/a'}`);
            const failed = psRuns.filter(r => r.conclusion !== 'success').slice(0,3);
            if (failed.length) {
              core.summary.addRaw('- Recent failures (up to 3):');
              for (const f of failed) {
                core.summary.addRaw(`  - ${f.name} â†’ ${f.html_url} (${f.conclusion})`);
              }
            }