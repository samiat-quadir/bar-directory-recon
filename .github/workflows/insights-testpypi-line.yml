name: insights-testpypi-line
on:
  workflow_dispatch:
  schedule:
    - cron: '30 14 * * 3'  # Wed 09:30 ET

jobs:
  insights:
    name: Insights signals
    runs-on: ubuntu-latest
    steps:
      - name: Compute parity/pack signals
        id: signals
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            async function latest(workflow){ try { const r = await github.rest.actions.listWorkflowRuns({owner, repo, workflow_id: workflow, per_page:1}); return r.data.workflow_runs[0]; } catch(e){ return null; } }
            const runPack = await latest('cli-pack.yml');
            let windows='unknown', ubuntu='unknown', last_ok='unknown';
            if (runPack) {
              const jobs = await github.rest.actions.listJobsForWorkflowRun({owner, repo, run_id: runPack.id});
              for (const j of jobs.data.jobs) {
                const name = (j.name||'').toLowerCase();
                if (name.includes('windows')) windows = j.conclusion === 'success' ? 'pass' : 'fail';
                if (name.includes('ubuntu'))  ubuntu  = j.conclusion === 'success' ? 'pass' : 'fail';
              }
              if (runPack.conclusion === 'success') last_ok = runPack.updated_at;
            }
            const runParity = await latest('release-qa-parity.yml');
            const parity_link = runParity?.html_url || 'unknown';
            core.setOutput('pack_smoke_summary', windows=\ ubuntu=\ last_ok=\);
            core.setOutput('parity_link', parity_link);

      - name: Append Insights signals
        shell: pwsh
        run: |
          "$pack = ${{ steps.signals.outputs.pack_smoke_summary }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "$parity = parity_link: ${{ steps.signals.outputs.parity_link }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
