name: fast-parity-ci
on:
    pull_request:
    push:
        branches: [main]
jobs:
    ubuntu:
        name: fast-tests (ubuntu-latest)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with: { python-version: "3.11" }
            - name: Cache pip
              uses: actions/cache@v4
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('requirements-lock.txt', 'requirements.txt', 'requirements-dev.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-
            - name: Install (prefer lockfile)
              run: |
                  python -m pip install -U pip
                  if [ -f requirements-lock.txt ]; then
                    python -m pip install -r requirements-lock.txt
                    python -m pip install -e .[dev] --no-deps
                  else
                    python -m pip install -e .[dev]
                  fi
            - name: Run fast tests
              run: pytest -q -m "not slow and not e2e and not integration"

    windows:
        name: fast-tests (windows-latest)
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with: { python-version: "3.11" }
            - name: Cache pip
              uses: actions/cache@v4
              with:
                  path: ${{ env.PIP_CACHE_DIR }}
                  key: ${{ runner.os }}-pip-${{ hashFiles('requirements-lock.txt', 'requirements.txt', 'requirements-dev.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-
            - name: Set pip cache dir (Windows)
              shell: pwsh
              run: |
                  # Typical pip cache path on Windows
                  echo "PIP_CACHE_DIR=$env:LOCALAPPDATA\pip\Cache" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            - name: Install (prefer lockfile)
              shell: pwsh
              run: |
                  python -m pip install -U pip
                  if (Test-Path 'requirements-lock.txt') {
                    python -m pip install -r requirements-lock.txt
                    python -m pip install -e .[dev] --no-deps
                  } else {
                    python -m pip install -e .[dev]
                  }
            - name: Run fast tests
              shell: pwsh
              run: pytest -q -m "not slow and not e2e and not integration"
