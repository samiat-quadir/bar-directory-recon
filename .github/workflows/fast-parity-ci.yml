name: fast-parity-ci
on:
  pull_request:
  push:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write
jobs:
  ubuntu:
    name: fast-tests (ubuntu-latest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with: 
          fetch-depth: 0
          submodules: false
      - name: Guard check
        id: guard
        uses: ./.github/actions/guard
      - name: Attic/workflow-only change short-circuit success  
        if: steps.guard.outputs.attic_only == 'true'
        run: echo "Attic/workflow-only change detected; skipping tests."
      - uses: actions/setup-python@v6
        if: steps.guard.outputs.workflow_only != 'true'
        with: 
          python-version: '3.11'
      - name: Cache pip
        if: steps.guard.outputs.attic_only != 'true'
        id: pip-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements-lock.txt', 'requirements.txt', 'requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Cache telemetry
        if: steps.guard.outputs.attic_only != 'true'
        run: |
          echo "### 📦 Pip Cache Telemetry (Ubuntu)" >> $GITHUB_STEP_SUMMARY
          echo "- Cache dir: \`~/.cache/pip\`" >> $GITHUB_STEP_SUMMARY
          echo "- Cache hit: \`${{ steps.pip-cache.outputs.cache-hit }}\`" >> $GITHUB_STEP_SUMMARY
      - name: Install (prefer lockfile)
        if: steps.guard.outputs.attic_only != 'true'
        run: |
          python -m pip install -U pip
          if [ -f requirements-lock.txt ]; then
            python -m pip install -r requirements-lock.txt
            python -m pip install -e . --no-deps
          else
            python -m pip install -e .
          fi
          # Always install dev dependencies for testing
          python -m pip install -r requirements-dev.txt
      - name: Run fast tests
        if: steps.guard.outputs.attic_only != 'true'
        run: pytest -q -m "not slow and not e2e and not integration"

  packaging-dry-run:
    name: packaging-dry-run
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Check for packaging changes
        id: check
        run: |
          changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '(pyproject\.toml|setup\.cfg|setup\.py|scripts/|\.github/workflows/cli-pack\.yml)' || true)
          if [ -n "$changed" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Packaging files changed:"
            echo "$changed"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No packaging files changed"
          fi
      - uses: actions/setup-python@v6
        if: steps.check.outputs.changed == 'true'
        with:
          python-version: '3.11'
      - name: Install build tools
        if: steps.check.outputs.changed == 'true'
        run: python -m pip install build twine
      - name: Build and check
        if: steps.check.outputs.changed == 'true'
        run: |
          python -m build
          twine check dist/*
          echo "✅ Packaging dry-run passed" >> $GITHUB_STEP_SUMMARY
      - name: Skipped
        if: steps.check.outputs.changed != 'true'
        run: echo "⏭️ No packaging changes detected; skipped" >> $GITHUB_STEP_SUMMARY

  windows:
    name: fast-tests (windows-latest)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v5
        with: 
          fetch-depth: 0
          submodules: false
      - name: Guard check
        id: guard
        uses: ./.github/actions/guard
      - name: Attic/workflow-only change short-circuit success
        if: steps.guard.outputs.attic_only == 'true'
        shell: pwsh
        run: Write-Host "Attic/workflow-only change detected; skipping tests."
      - uses: actions/setup-python@v6
        if: steps.guard.outputs.workflow_only != 'true'
        with: 
          python-version: '3.11'
      - name: Set pip cache dir
        if: steps.guard.outputs.workflow_only != 'true'
        shell: pwsh
        run: echo "PIP_CACHE_DIR=$env:LOCALAPPDATA\pip\Cache" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - name: Cache pip
        if: steps.guard.outputs.workflow_only != 'true'
        id: pip-cache-win
        uses: actions/cache@v4
        with:
          path: ${{ env.PIP_CACHE_DIR }}
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements-lock.txt', 'requirements.txt', 'requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Cache telemetry
        if: steps.guard.outputs.workflow_only != 'true'
        shell: pwsh
        run: |
          "### 📦 Pip Cache Telemetry (Windows)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- Cache dir: ``$env:PIP_CACHE_DIR``" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- Cache hit: ``${{ steps.pip-cache-win.outputs.cache-hit }}``" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
      - name: Install (prefer lockfile)
        if: steps.guard.outputs.workflow_only != 'true'
        shell: pwsh
        run: |
          python -m pip install -U pip
          if (Test-Path 'requirements-lock.txt') {
            python -m pip install -r requirements-lock.txt
            python -m pip install -e . --no-deps
          } else {
            python -m pip install -e .
          }
          # Always install dev dependencies for testing
          python -m pip install -r requirements-dev.txt
      - name: Run fast tests
        if: steps.guard.outputs.workflow_only != 'true'
        shell: pwsh
        run: pytest -q -m "not slow and not e2e and not integration"
      - name: CI minutes saved (24h)
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const since = new Date(Date.now() - 24*60*60*1000);
            const { owner, repo } = context.repo;
            const wf = context.workflow;
            const runs = await github.paginate(github.rest.actions.listWorkflowRunsForRepo, {
              owner, repo, status: 'cancelled', per_page: 100
            });
            const recent = runs.filter(r => new Date(r.run_started_at) >= since && r.name === wf);
            core.summary.addHeading('CI minutes saved (24h)');
            core.summary.addRaw(`Group: ${wf}-${context.ref}`);
            core.summary.addRaw(`\nCancelled runs: ${recent.length}`);
            await core.summary.write();
      - name: Compose PR status (status-bot)
        if: ${{ github.event_name == 'pull_request' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .status
          verdict='unknown'
          details='{}'
          if [ -f scripts/check_guard_integrity.py ]; then
            python scripts/check_guard_integrity.py > .status/guard.json || true
            verdict=$(jq -r '.status // "unknown"' .status/guard.json 2>/dev/null || echo "unknown")
            details=$(cat .status/guard.json 2>/dev/null || echo '{}')
          fi
          lock_present="false"; [ -f requirements-lock.txt ] && lock_present="true"
          pslint=""
          if [ -f .status/pslint.txt ]; then pslint="$(cat .status/pslint.txt)"; fi
          cat > .status/comment.md <<STATUSEOF
          <!-- status-bot -->
          **CI status bot**

          - Required checks: \`audit\`, \`fast-tests (ubuntu-latest)\`, \`fast-tests (windows-latest)\`, \`workflow-guard\`
          - Guard verdict: **${verdict}**
          - Lock present: **${lock_present}**
          ${pslint}
          <details><summary>Guard JSON</summary>

          \`\`\`json
          ${details}
          \`\`\`
          </details>
          STATUSEOF

      - name: Post PR status comment (status-bot)
        if: ${{ github.event_name == 'pull_request' }}
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          pr="${{ github.event.pull_request.number }}"
          body=".status/comment.md"
          gh pr view "$pr" >/dev/null
          last=$(gh pr comments "$pr" --json body,id | jq -r '[.[] | select(.body|contains("<!-- status-bot -->"))][-1].id // empty')
          if [ -n "$last" ]; then
            gh pr comment "$pr" --comment-id "$last" --body-file "$body"
          else
            gh pr comment "$pr" --body-file "$body"
          fi