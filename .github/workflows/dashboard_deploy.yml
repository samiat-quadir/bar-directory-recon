name: Dashboard Deployment

on:
  push:
    branches: [main, master]
    paths:
      - 'output/*.html'
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      force_deploy:
        description: 'Force deploy even if no changes detected'
        required: false
        type: boolean
        default: false

jobs:
  deploy-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Create logs directory
        run: mkdir -p logs

      - name: Check for HTML files
        id: check-html
        run: |
          if [ -d "output" ] && [ "$(find output -name '*.html' | wc -l)" -gt 0 ]; then
            echo "html_exists=true" >> $GITHUB_OUTPUT
            echo "Found HTML files in output directory" | tee -a logs/deploy.log
          else
            echo "html_exists=false" >> $GITHUB_OUTPUT
            echo "No HTML files found in output directory" | tee -a logs/deploy.log
          fi

      - name: Create docs directory if it doesn't exist
        run: |
          mkdir -p docs
          echo "Created docs directory" | tee -a logs/deploy.log

      - name: Copy HTML files to docs directory
        if: steps.check-html.outputs.html_exists == 'true' || inputs.force_deploy == 'true'
        run: |
          echo "Copying HTML files to docs directory..." | tee -a logs/deploy.log
          cp -v output/*.html docs/ 2>&1 | tee -a logs/deploy.log

          # Create an index.html file if it doesn't exist
          if [ ! -f docs/index.html ] && [ -f "$(ls -1 docs/*.html 2>/dev/null | head -n1)" ]; then
            FIRST_HTML=$(ls -1 docs/*.html | head -n1)
            echo "Creating index.html from $FIRST_HTML" | tee -a logs/deploy.log
            cp "$FIRST_HTML" docs/index.html
          elif [ ! -f docs/index.html ]; then
            echo "No HTML files found to create index.html" | tee -a logs/deploy.log
            echo "<html><head><title>Dashboard</title></head><body><h1>Dashboard</h1><p>No content available yet.</p></body></html>" > docs/index.html
            echo "Created default index.html" | tee -a logs/deploy.log
          fi

          # List files in docs directory
          echo "Files in docs directory:" | tee -a logs/deploy.log
          ls -la docs/ | tee -a logs/deploy.log

      - name: Upload logs as artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: deployment-logs
          path: logs/
          retention-days: 7

      - name: Commit and push changes
        run: |
          if [[ -n $(git status -s) || "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
            echo "Changes detected in docs directory, preparing commit..." | tee -a logs/deploy.log

            git config --global user.name "GitHub Actions Bot"
            git config --global user.email "actions@github.com"

            git add docs/

            # Create a useful commit message with timestamp
            COMMIT_MSG="Auto-deploy dashboard to GitHub Pages [$(date '+%Y-%m-%d %H:%M:%S UTC')]"

            if [[ "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
              COMMIT_MSG="$COMMIT_MSG [FORCED]"
            fi

            git commit -m "$COMMIT_MSG [skip ci]"
            git push

            echo "Changes pushed successfully!" | tee -a logs/deploy.log
          else
            echo "No changes to commit in docs directory" | tee -a logs/deploy.log
          fi
