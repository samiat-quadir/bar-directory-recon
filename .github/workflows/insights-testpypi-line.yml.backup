name: insights-testpypi-line
on:
  workflow_dispatch:
  schedule:
    - cron: '30 14 * * 3'   # Wed 09:30 ET (14:30 UTC)
permissions:
  contents: read
  issues: write
jobs:
  testpypi-line:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Compute TestPyPI line
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          # package name from pyproject
          PKG=$(python - <<'PY'
import tomllib,sys
with open("pyproject.toml","rb") as f: d=tomllib.load(f)
print(d.get("project",{}).get("name","bar-directory-recon"))
PY
)
          # last publish-testpypi run
          STAT=$(gh run list --workflow publish-testpypi --limit 1 --json conclusion -q '.[0].conclusion' || echo "none")
          RUN=$(gh run list --workflow publish-testpypi --limit 1 --json htmlUrl -q '.[0].htmlUrl' || echo "")
          # try to derive last rc version (fallback to rc1)
          VER=$(git tag --list 'v*rc*' | sort -V | tail -n1 | sed 's/^v//' || echo "0.1.1rc1")
          URL="https://test.pypi.org/project/$PKG/$VER/"
          LINE="**TestPyPI:** $STAT ΓÇö $URL"
          echo "$LINE" >> $GITHUB_STEP_SUMMARY
          echo "$LINE" > line.txt
      - name: Comment on latest CI Insights issue (best-effort)
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          NUM=$(gh issue list --state open --limit 10 --json number,title -q '.[] | select(.title | test("CI Insights"; "i")) | .number' | head -n1 || true)
          if [ -n "$NUM" ]; then
            gh issue comment "$NUM" -F line.txt || true
          else
            echo "No open Insights issue found; skipped comment."
          fi
